<template>
  <div class="app-container" :class="{ 'app-dark': isDarkMode }">
    <!-- 顶部导航栏 -->
    <header v-show="!isFullScreen" class="header">
      <div class="header-content">
        <div class="logo">
            <svg class="logo-icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="64" height="64"><path d="M741.888 224.085333C555.633778 375.580444 491.576889 512.512 483.555556 568.888889l0.056888 85.333333c-34.702222 173.511111 25.827556 124.757333 129.934223 41.016889 45.397333-36.522667 99.100444-79.758222 156.842666-114.062222 11.605333 86.755556 27.648 172.373333 49.664 243.484444 12.515556 40.391111-16.384 85.560889-58.709333 85.560889h-449.991111c-86.186667 0-165.774222-48.924444-187.164445-132.380444-44.771556-175.559111-59.733333-412.103111-64.739555-550.343111C57.116444 164.693333 107.861333 113.777778 170.666667 113.777778h455.111111c61.724444 0 112.184889 49.095111 116.110222 110.307555zM199.111111 284.444444a28.444444 28.444444 0 0 0 0 56.888889h227.555556a28.444444 28.444444 0 0 0 0-56.888889h-227.555556z m56.888889 170.666667a28.444444 28.444444 0 0 0 0 56.888889h113.777778a28.444444 28.444444 0 0 0 0-56.888889h-113.777778z m284.444444 170.666667c9.500444-66.389333 96.711111-244.622222 369.777778-426.666667 45.511111-22.755556 75.832889-66.389333 85.333334-85.333333 37.944889 66.389333 62.577778 227.555556-142.222223 341.333333s-312.888889 218.055111-341.333333 256l28.444444-85.333333z" fill="#505E78"></path></svg>
          <span style="font-size: 1.2rem">素笔 Mark</span>
        </div>

        <div class="header-actions">
          <!-- 主题切换按钮 -->
          <div class="theme-toggle" @click="toggleTheme">
            <div class="toggle-thumb" :class="{ 'toggle-thumb-dark': isDarkMode }"></div>
            <span class="sun-icon">
              <svg class="icon" viewBox="0 0 1025 1024" xmlns="http://www.w3.org/2000/svg" width="48" height="48"><path d="M512.640801 798.010847a289.001252 289.001252 0 1 1 288.14685-289.001252A289.428452 289.428452 0 0 1 512.640801 798.010847z m0-513.922403a224.921151 224.921151 0 1 0 224.06675 224.921151A225.134752 225.134752 0 0 0 512.640801 284.088444zM274.476429 291.564456a32.04005 32.04005 0 0 1-21.360034-8.544014L178.142678 213.600334a32.04005 32.04005 0 0 1 43.788069-46.778473l74.546516 69.847309a32.04005 32.04005 0 0 1-21.360033 55.322486zM64.0801 536.991239a32.04005 32.04005 0 0 1 0-64.0801L165.113058 469.920734a32.04005 32.04005 0 0 1 1.922403 64.0801l-101.887359 3.204005zM190.958698 856.110138a31.82645 31.82645 0 0 1-23.496036-53.827284l69.847309-74.546517a32.25365 32.25365 0 0 1 45.283271-1.495202 31.82645 31.82645 0 0 1 1.495202 45.283271L213.600334 846.070922a32.25365 32.25365 0 0 1-22.641636 10.039216zM506.232791 992.17355A32.04005 32.04005 0 0 1 474.192741 961.201502l-3.204005-101.887359a32.04005 32.04005 0 1 1 64.0801-2.136004l3.417605 102.10096a32.25365 32.25365 0 0 1-31.185648 33.108052zM825.35169 865.294952a31.399249 31.399249 0 0 1-21.360034-8.757614l-74.546516-69.847309a32.04005 32.04005 0 0 1 44.001669-46.564873l74.332916 69.84731a31.82645 31.82645 0 0 1 0.854401 44.428869 32.680851 32.680851 0 0 1-23.282436 10.893617zM859.100542 553.224864a32.04005 32.04005 0 0 1 0-64.0801l102.10096-3.204005a32.04005 32.04005 0 0 1 2.136003 64.0801l-102.100959 3.204005zM764.475594 305.448477a32.25365 32.25365 0 0 1-21.360033-8.757613 31.82645 31.82645 0 0 1-1.495202-45.283271L811.681268 177.074677a32.04005 32.04005 0 1 1 46.778473 43.788068l-69.847309 74.332916a32.04005 32.04005 0 0 1-24.136838 10.252816z" fill="#8a8a8a"></path><path d="M522.252816 196.939508A31.82645 31.82645 0 0 1 491.280768 165.967459L487.008761 64.0801a32.04005 32.04005 0 0 1 31.185649-32.894451A31.399249 31.399249 0 0 1 551.088861 61.944097l4.272007 102.100959a31.82645 31.82645 0 0 1-32.04005 32.894452z" fill="#8a8a8a"></path></svg>
            </span>
            <span class="moon-icon">
              <svg class="icon" viewBox="0 0 1025 1024" xmlns="http://www.w3.org/2000/svg" width="48" height="48"><path d="M542.331247 955.220693a431.045474 431.045474 0 0 1-21.360033-861.450146 32.467251 32.467251 0 0 1 28.408844 14.311222 32.04005 32.04005 0 0 1 1.922403 31.82645A363.120567 363.120567 0 0 0 514.563204 299.040467a367.606174 367.606174 0 0 0 367.178974 368.033375H899.471005a32.25365 32.25365 0 0 1 30.331248 46.137672 427.200668 427.200668 0 0 1-387.471006 242.009179z m-69.633708-790.321235A366.965373 366.965373 0 1 0 845.857322 729.65874 431.686275 431.686275 0 0 1 450.483104 299.040467a427.200668 427.200668 0 0 1 22.214435-135.209011z" fill="#ffffff"></path></svg>
            </span>
          </div>

          <!-- 下载按钮组 -->
          <div class="download-btn-group">
            <button class="primary-btn" @click.stop="showDropdown = !showDropdown">
              <span>导出 ｜ ▼</span>
            </button>
            <div class="dropdown-menu" :class="{ 'dropdown-show': showDropdown }" @click.stop>
              <!-- 下载选项 -->
              <div class="dropdown-options">
                <div class="dropdown-item" @click="downloadMarkdown">
                  <svg class="file-icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="48" height="48"><path d="M941.335155 482.458783h-26.358201V220.474241a9.5848 9.5848 0 0 0-0.575088-3.194933 9.5848 9.5848 0 0 0-2.236453-10.000142l-204.47574-204.47574A9.5848 9.5848 0 0 0 691.331614 9.608635v204.475739a9.5848 9.5848 0 0 0 9.5848 9.584801h194.89094v258.789608h-747.614424V20.790902h500.007082a9.5848 9.5848 0 0 0 0-19.169601H138.608129a9.5848 9.5848 0 0 0-9.5848 9.5848V482.458783h-26.358201a27.955668 27.955668 0 0 0-27.955667 27.955667v327.480677a27.955668 27.955668 0 0 0 27.955667 27.955668h26.358201v52.173263a106.07179 106.07179 0 0 0 105.943993 105.975942h670.424832a9.5848 9.5848 0 0 0 9.5848-9.5848V865.850795h26.358201a27.955668 27.955668 0 0 0 27.955667-27.955668v-327.480677a27.955668 27.955668 0 0 0-27.955667-27.955667z m-230.833941-277.959209V32.739953L882.228886 204.499574z m-80.576221 353.104043l34.473332 157.094877 41.821678-157.094877H761.204808l40.096415 159.746672 35.144267-159.746672h46.486282l-55.655741 228.693335h-48.978329l-45.559751-170.992837-45.400004 170.992837h-50.064607l-54.601412-228.693335z m-172.526405 0h48.818582l91.726539 228.693335h-50.224353l-19.968334-51.949617h-91.407046l-18.882056 51.949617h-48.97833z m-296.393975 0h97.349622q36.645886 0 53.25954 6.166222a52.556655 52.556655 0 0 1 26.613795 21.917243 65.911477 65.911477 0 0 1 10.000142 36.038849 61.055178 61.055178 0 0 1-15.143984 42.492615q-15.143984 16.773401-45.240258 21.150459a107.829003 107.829003 0 0 1 24.728785 19.169601 260.930214 260.930214 0 0 1 26.294302 37.125126l27.923718 44.729068H311.549876l-33.387054-49.840961A322.879973 322.879973 0 0 0 253.817429 702.90919a35.463761 35.463761 0 0 0-13.89796-9.5848 76.103314 76.103314 0 0 0-23.259116-2.587897h-9.329205v95.560459H161.16436z m734.642994 447.290681H234.967322a86.902189 86.902189 0 0 1-86.806342-86.806341V865.850795h747.614424z" fill="#FFC152"></path><path d="M481.424487 610.959006l-30.895006 84.857432h62.39705l-31.502044-84.857432zM282.987171 651.502711a24.888531 24.888531 0 0 0 12.939481-9.5848 29.77678 29.77678 0 0 0 4.664603-17.156793 27.444478 27.444478 0 0 0-6.166222-18.626462 28.275161 28.275161 0 0 0-17.380438-8.977763q-5.623083-0.766784-33.706548-0.766784H207.331148v58.019991h34.153838q33.227308-0.095848 41.502185-2.907389z" fill="#FFC152"></path></svg>
                  <span>Markdown文件</span>
                </div>
                <div class="dropdown-item" @click="downloadPdf">
                  <svg class="file-icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="48" height="48"><path d="M330.399984 670.065274a30.319918 30.319918 0 0 0 14.441099-11.246166 30.767209 30.767209 0 0 0 5.207741-17.795779 29.553134 29.553134 0 0 0-7.316397-20.60732 31.949334 31.949334 0 0 0-18.562564-10.127939 222.047874 222.047874 0 0 0-33.227307-1.565518h-22.364534v64.889098h25.271923q27.34863 0.031949 36.550039-3.546376zM562.607746 748.532839q7.412246-6.70936 12.076848-22.07699a149.171442 149.171442 0 0 0 4.664603-41.885577q0-26.517948-4.664603-40.703452a52.33301 52.33301 0 0 0-13.099227-22.140889 43.962284 43.962284 0 0 0-21.374105-10.766925q-9.5848-2.172555-37.92386-2.172555h-20.735118v151.471794h34.473332a125.75258 125.75258 0 0 0 27.923718-2.172555 42.620412 42.620412 0 0 0 18.658412-9.552851z" fill="#FF0741"></path><path d="M938.044374 482.458783h-26.358201V220.474241a9.5848 9.5848 0 0 0-0.575088-3.194933 9.5848 9.5848 0 0 0-2.236454-10.000142l-204.47574-204.47574A9.5848 9.5848 0 0 0 688.040832 9.608635v204.475739a9.5848 9.5848 0 0 0 9.584801 9.584801h194.890939v258.789608h-747.614424V20.790902h500.007083a9.5848 9.5848 0 0 0 0-19.169601H135.317348a9.5848 9.5848 0 0 0-9.5848 9.5848V482.458783h-26.358201a27.955668 27.955668 0 0 0-27.955668 27.955667v327.480677a27.955668 27.955668 0 0 0 27.955668 27.955668h26.358201v52.173263a106.07179 106.07179 0 0 0 105.943992 105.975942H902.101372a9.5848 9.5848 0 0 0 9.584801-9.5848V865.850795h26.358201a27.955668 27.955668 0 0 0 27.955667-27.955668v-327.480677a27.955668 27.955668 0 0 0-27.955667-27.955667zM707.210433 204.499574V32.739953L878.970054 204.499574z m-40.607604 365.564284h156.775384v38.690644h-110.608596v54.122172h95.464611v38.690644h-95.464611V798.757193h-46.166788z m-231.185383 0h84.410141q28.562705 0 43.514993 4.377058a76.486706 76.486706 0 0 1 34.473332 21.054612 99.969467 99.969467 0 0 1 21.853345 37.061228 168.788333 168.788333 0 0 1 7.348347 54.026324 150.161871 150.161871 0 0 1-7.028854 48.658836 100.832099 100.832099 0 0 1-24.505139 40.415908 81.183259 81.183259 0 0 1-32.364676 18.275019 139.65054 139.65054 0 0 1-40.831249 4.82435H435.321598z m-212.942314 0h74.090507q42.109223 0 54.920905 3.418578a59.968901 59.968901 0 0 1 32.907815 22.364534q13.258974 17.252641 13.258973 44.537373a74.601696 74.601696 0 0 1-7.635891 35.399862 62.716543 62.716543 0 0 1-19.425195 22.55623 67.093602 67.093602 0 0 1-23.962001 10.830824 263.613958 263.613958 0 0 1-47.924001 3.194934h-30.064324v86.263203H222.443183zM892.516572 1004.830399H231.67654a86.902189 86.902189 0 0 1-86.774392-86.806341V865.850795h747.614424z" fill="#FF0741"></path></svg>
                  <span>PDF文件</span>
                </div>
                <div class="dropdown-item" @click="downloadHtml">
                  <svg class="file-icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="48" height="48"><path d="M940.344726 482.458783h-26.358201V220.474241a9.5848 9.5848 0 0 0-0.575088-3.194933 9.5848 9.5848 0 0 0-2.236454-10.000142l-204.475739-204.47574A9.5848 9.5848 0 0 0 690.341184 9.608635v204.475739a9.5848 9.5848 0 0 0 9.584801 9.584801h194.890939v258.789608h-747.614424V20.790902h500.007083a9.5848 9.5848 0 0 0 0-19.169601H137.6177a9.5848 9.5848 0 0 0-9.5848 9.5848V482.458783h-26.358201a27.955668 27.955668 0 0 0-27.955668 27.955667v327.480677a27.955668 27.955668 0 0 0 27.955668 27.955668h26.358201v52.173263A106.07179 106.07179 0 0 0 234.040791 1024h670.360933a9.5848 9.5848 0 0 0 9.584801-9.5848V865.850795h26.358201a27.955668 27.955668 0 0 0 27.955667-27.955668v-327.480677a27.955668 27.955668 0 0 0-27.955667-27.955667z m-230.833941-277.959209V32.739953L881.270406 204.499574z m-190.322185 367.417345h64.537656l38.754542 145.688965 38.339201-145.688965h64.665453v213.549351h-40.096415v-168.085448L642.992271 785.46627h-41.534135l-42.23702-168.117398v168.117398h-40.032516z m-196.967646 0h169.714864v36.134697h-63.227733v177.446603h-43.131601v-177.446603H322.220954zM122.218121 785.46627V571.916919h43.131601v84.058699h84.47404V571.916919h43.131602v213.549351h-43.131602v-93.355955H165.317773v93.387904z m772.598803 219.364129H234.040791a86.902189 86.902189 0 0 1-86.806341-86.806341V865.850795h747.614423z m24.98438-219.364129h-150.353568v-211.824087h43.131602v175.721339h107.221966z" fill="#697BC9"></path></svg>
                  <span>HTML文件</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </header>
    <!-- 主内容区 -->
    <main class="main-content" :class="{ 'full-screen': isFullScreen }">
      <!-- 编辑器区域 -->
      <div v-show="!onlyPreview" class="editor-container" :class="{ 'only-edit': onlyEdit }">

        <div class="panel-header editor-header">
          <Tooltip
              content="沉浸式编辑"
              :is-dark-mode="isDarkMode"
          >
            <div class="upload-btn" @click="onlyEdit = !onlyEdit">
              <svg class="upload-icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="200" height="200"><path d="M514.871 955.411l0.426-95 445.3 1.996-0.426 95zM642 65.8l-576 576 0.2 0.2v316.2H382v-0.4l0.3 0.3 576-576L642 65.8z m182 316.3l-89.1 89.1-182-182 89.1-89.1 182 182zM161.2 863.2V737l126.2 126.2H161.2z m39.1-221.4l282-282 182 182-282 282-182-182z" fill="#999999"></path></svg>
            </div>
          </Tooltip>
          <span style="font-size: 1rem">编辑区域</span>

          <!-- 功能按钮组 -->
          <Tooltip
              content="上传图片或文件"
              :is-dark-mode="isDarkMode"
              style="margin-left: auto"
          >
            <div class="upload-btn" @click="openFileSelect()"><svg class="upload-icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="64" height="64"><path d="M942.272 592.192a34.944 34.944 0 0 1 17.472 30.336v249.92c0 48.128-39.168 87.296-87.424 87.296H152.32a87.424 87.424 0 0 1-87.36-87.424V622.528a34.944 34.944 0 1 1 69.888 0v249.92c0 9.6 7.808 17.472 17.536 17.472h720a17.472 17.472 0 0 0 17.536-17.536V622.528a34.944 34.944 0 0 1 52.48-30.336zM512.768 64.96c9.344 0 18.304 3.776 24.896 10.432l236.8 237.696a34.944 34.944 0 0 1-24.448 59.392 34.944 34.944 0 0 1-24.512-10.496L547.264 184.512v534.08a34.944 34.944 0 0 1-34.944 35.008 34.944 34.944 0 0 1-34.944-35.072V184.448L299.072 361.984a35.2 35.2 0 0 1-49.792-49.792l238.592-236.8a34.944 34.944 0 0 1 24.896-10.432z" fill="#999999"></path></svg></div>
          </Tooltip>

          <Tooltip
              content="插入代码块"
              :is-dark-mode="isDarkMode"
          >
          <div class="upload-btn" @click="showCodeModal = true"><svg class="upload-icon" viewBox="0 0 1706 1024" xmlns="http://www.w3.org/2000/svg" width="64" height="64"><path d="M985.856 17.408a85.333333 85.333333 0 0 1 60.330667 104.533333l-220.842667 824.32a85.333333 85.333333 0 1 1-164.864-44.202666L881.322667 77.653333a85.333333 85.333333 0 0 1 104.533333-60.330666z m-506.88 43.264a85.333333 85.333333 0 0 1 21.077333 110.933333l-5.973333 8.789334L235.946667 512l257.962666 331.605333a85.333333 85.333333 0 0 1-6.826666 112.64l-8.106667 7.082667a85.333333 85.333333 0 0 1-112.64-6.826667l-7.082667-8.106666-298.666666-384a85.333333 85.333333 0 0 1-6.485334-95.232l6.485334-9.557334 298.666666-384A85.333333 85.333333 0 0 1 479.061333 60.672z m861.269333 6.826667l7.082667 8.106666 298.666667 384a85.333333 85.333333 0 0 1 6.485333 95.232l-6.485333 9.557334-298.666667 384a85.333333 85.333333 0 0 1-140.8-95.914667l6.144-8.874667L1470.634667 512l-257.962667-331.605333a85.333333 85.333333 0 0 1 6.826667-112.64l8.106666-7.082667a85.333333 85.333333 0 0 1 112.64 6.826667z" fill="#999999"></path></svg></div>
          </Tooltip>
          <Tooltip
              content="插入表格"
              :is-dark-mode="isDarkMode"
          >
          <div class="upload-btn" @click="showTableModal = true"><svg class="upload-icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="64" height="64"><path d="M907.002003 0.000731a95.085239 95.085239 0 0 1 95.085239 87.77099v299.884215h-614.396928v621.711177h-292.569966a95.450951 95.450951 0 0 1-95.085239-87.77099V95.08597a90.696689 90.696689 0 0 1 87.77099-95.085239h819.195904z m-599.76843 694.853669h-234.055973v219.427474c0 7.314249 7.314249 14.628498 14.628499 21.942748h219.427474V694.8544z m0-307.198464h-234.055973v234.055973h234.055973V387.655936z m0-314.512713h-212.113225c-7.314249 0-14.628498 7.314249-21.942748 14.628498v219.427474h234.055973V73.143223z m307.198464 0h-226.741723v234.055972h234.055972V73.143223z m292.569966 0h-212.113225v234.055972h234.055972V95.08597l-21.942747-21.942747z" fill="#999999"></path><path d="M746.088522 468.039534a57.709426 57.709426 0 0 1 58.513993 58.513993v168.227731h168.22773a48.932327 48.932327 0 0 1 51.199744 43.885494v7.31425a57.709426 57.709426 0 0 1-58.513993 58.513993h-168.22773v168.22773a48.932327 48.932327 0 0 1-43.885495 51.199744h-7.314249a57.709426 57.709426 0 0 1-58.513994-58.513993v-168.22773h-168.22773a48.932327 48.932327 0 0 1-51.199744-43.885495v-7.314249a57.709426 57.709426 0 0 1 58.513993-58.513994h168.227731v-168.22773a48.932327 48.932327 0 0 1 43.885494-51.199744h7.31425z" fill="#999999"></path></svg></div>
          </Tooltip>
          <Tooltip
              content="插入公式"
              :is-dark-mode="isDarkMode"
          >
            <div class="upload-btn" @click="showMathModal = true"><svg class="upload-icon" viewBox="0 0 1053 1024" xmlns="http://www.w3.org/2000/svg" width="200" height="200"><path d="M95.941353 671.543695l-71.544053 0.961244-1.190112-91.547092 133.384113-1.785168 34.375933 82.392383L333.826472 91.547092h696.39873v91.547092H405.141657L212.618122 951.540477zM446.887131 883.42944l157.369451-266.722453-152.746323-292.538733h415.944213l57.766215 137.320638-84.360645 35.474498-34.192839-81.431138h-204.150016l106.377722 203.646506-101.800367 172.70359h200.625453l33.735103-73.786957 83.170533 38.083591-58.178177 127.250458z" fill="#999999"></path></svg>            </div>
          </Tooltip>
          <Tooltip
              content="插入表情符号"
              :is-dark-mode="isDarkMode"
          >
          <div class="upload-btn" @click="showEmojiModal = true">
            <svg class="upload-icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="200" height="200"><path d="M512 0C229.2 0 0 229.2 0 512s229.2 512 512 512 512-229.2 512-512S794.8 0 512 0z m0 960C265 960 64 759 64 512S265 64 512 64s448 201 448 448-201 448-448 448z" fill="#999999"></path><path d="M320 405.3m-64 0a64 64 0 1 0 128 0 64 64 0 1 0-128 0Z" fill="#999999"></path><path d="M704 405.3m-64 0a64 64 0 1 0 128 0 64 64 0 1 0-128 0Z" fill="#999999"></path><path d="M512 810.7c117.8 0 213.3-95.5 213.3-213.3H298.7c0 117.8 95.5 213.3 213.3 213.3z" fill="#999999"></path></svg>
          </div>
          </Tooltip>
          <Tooltip
              content="可视化编辑json结构"
              :is-dark-mode="isDarkMode"
          >
          <div class="upload-btn" @click="showJsonModal = true">
            <svg class="upload-icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="200" height="200"><path d="M461.2 308H98.9c-17.7 0-32-14.3-32-32V32c0-17.7 14.3-32 32-32h362.3c17.7 0 32 14.3 32 32v244c0 17.6-14.4 32-32 32z m-330.3-64h298.3V64H130.9v180zM925.1 668.1H613.7c-17.7 0-32-14.3-32-32V426.4c0-17.7 14.3-32 32-32h311.4c17.7 0 32 14.3 32 32v209.7c0 17.7-14.3 32-32 32z m-279.4-64h247.4V458.4H645.7v145.7zM925.1 1024H613.7c-17.7 0-32-14.3-32-32V782.3c0-17.7 14.3-32 32-32h311.4c17.7 0 32 14.3 32 32V992c0 17.7-14.3 32-32 32z m-279.4-64h247.4V814.3H645.7V960z" fill="#999999"></path><path d="M613.7 919.2H280c-17.7 0-32-14.3-32-32V296.1c0-17.7 14.3-32 32-32s32 14.3 32 32v559.1h301.6c17.7 0 32 14.3 32 32 0.1 17.6-14.2 32-31.9 32z" fill="#999999"></path><path d="M613.7 563.2H280c-17.7 0-32-14.3-32-32s14.3-32 32-32h333.6c17.7 0 32 14.3 32 32 0.1 17.7-14.2 32-31.9 32z" fill="#999999"></path></svg>
          </div>
          </Tooltip>
        </div>

        <textarea
            v-model="markdownContent"
            class="editor-textarea"
            placeholder="在此输入内容..."
            ref="editorRef"
            @scroll="handleEditorScroll"
            @keydown="handleKeyDown"
        ></textarea>
      </div>

      <!-- 预览区域 -->
      <div v-show="!onlyEdit" class="preview-container" :class="{ 'only-preview': onlyPreview }">
        <div class="panel-header preview-header">
          <Tooltip
              content="沉浸式预览"
              :is-dark-mode="isDarkMode"
          >
            <div class="upload-btn" @click="onlyPreview = !onlyPreview">
              <svg class="upload-icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" id="mx_n_1753685709610" width="128" height="128"><path d="M977.824 454.016C826.432 280.288 672.512 192 516.128 192c-156.384 0-310.304 88.288-461.696 262.016a112 112 0 0 0-1.632 145.248c138.24 165.984 293.088 250.24 463.328 250.24s325.088-84.256 463.328-250.24a112 112 0 0 0-1.632-145.248z m-47.552 104.32c-126.848 152.32-264.48 227.2-414.144 227.2s-287.296-74.88-414.144-227.2a48 48 0 0 1 0.704-62.24C243.008 335.072 380.8 256 516.128 256s273.152 79.072 413.44 240.064c15.488 17.792 15.776 44.16 0.704 62.272z"  fill="#999999"></path><path d="M512 288a224 224 0 1 0 0 448 224 224 0 0 0 0-448z m-64 224a64 64 0 1 1 0.032-128.032A64 64 0 0 1 448 512z" fill="#999999"></path></svg>
            </div>
          </Tooltip>
          <span style="font-size: 1rem">预览区域</span>
          <!-- 功能按钮组 -->
          <Tooltip
              content="html渲染"
              :is-dark-mode="isDarkMode"
              style="margin-left: auto"
          >
            <div class="upload-btn" @click="isHtmlMode = !isHtmlMode"><svg class="upload-icon" :class="{'red': isHtmlMode}" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="16" height="16"><path d="M186.02666667 228.69333333c-25.6 107.52 0 225.28 75.09333333 339.62666667 1.70666667 3.41333333 3.41333333 8.53333333 5.12 13.65333333 6.82666667 23.89333333 5.12 46.08-6.82666667 68.26666667-10.24 22.18666667-30.72 35.84-52.90666666 44.37333333-8.53333333 1.70666667-18.77333333 3.41333333-25.6 3.41333334-35.84 0-69.97333333-22.18666667-85.33333334-56.32 0-1.70666667-1.70666667-1.70666667-1.70666666-3.41333334-1.70666667-3.41333333-3.41333333-8.53333333-3.41333334-11.94666666 0-1.70666667 0-3.41333333-1.70666666-3.41333334-27.30666667-139.94666667-6.82666667-254.29333333 56.32-346.45333333 13.65333333-17.06666667 27.30666667-34.13333333 40.96-47.78666667zM460.8 6.82666667z m0 0s-544.42666667 90.45333333-440.32 631.46666666c1.70666667 5.12 6.82666667 27.30666667 10.24 32.42666667 27.30666667 61.44 87.04 98.98666667 151.89333333 98.98666667 15.36 0 30.72-1.70666667 46.08-6.82666667 87.04-27.30666667 133.12-117.76 105.81333334-203.09333333-3.41333333-10.24-6.82666667-22.18666667-11.94666667-30.72C170.66666667 296.96 273.06666667 105.81333333 460.8 6.82666667"></path><path d="M754.34666667 653.65333333c22.18666667 0 42.66666667 8.53333333 59.73333333 23.89333334 32.42666667 29.01333333 39.25333333 78.50666667 13.65333333 117.76l-8.53333333 6.82666666-8.53333333 8.53333334c-95.57333333 87.04-197.97333333 131.41333333-302.08 131.41333333-27.30666667 0-54.61333333-3.41333333-80.21333334-8.53333333 104.10666667-34.13333333 191.14666667-114.34666667 249.17333334-237.22666667 3.41333333-3.41333333 6.82666667-8.53333333 11.94666666-15.36 17.06666667-17.06666667 39.25333333-27.30666667 64.85333334-27.30666667z m0-71.68c-44.37333333 0-88.74666667 18.77333333-121.17333334 54.61333334-6.82666667 8.53333333-13.65333333 18.77333333-20.48 27.30666666C539.30666667 819.2 426.66666667 884.05333333 310.61333333 884.05333333c-73.38666667 0-146.77333333-25.6-220.16-66.56 0 0 172.37333333 201.38666667 414.72 201.38666667 107.52 0 228.69333333-39.25333333 354.98666667-153.6 3.41333333-3.41333333 20.48-22.18666667 23.89333333-25.6 47.78666667-68.26666667 39.25333333-160.42666667-23.89333333-215.04-27.30666667-30.72-68.26666667-42.66666667-105.81333333-42.66666667" fill="#999999"></path><path d="M588.8 95.57333333h3.41333333c3.41333333 0 8.53333333 1.70666667 13.65333334 3.41333334 3.41333333 0 6.82666667 1.70666667 10.24 1.70666666 136.53333333 40.96 232.10666667 114.34666667 281.6 215.04 8.53333333 18.77333333 15.36 35.84 23.89333333 56.32-71.68-63.14666667-168.96-97.28-279.89333333-97.28-15.36 0-34.13333333 0-52.90666667 1.70666667-3.41333333 0-10.24-1.70666667-15.36-1.70666667-23.89333333-5.12-42.66666667-18.77333333-58.02666667-39.25333333-13.65333333-20.48-18.77333333-42.66666667-13.65333333-66.56 6.82666667-42.66666667 44.37333333-73.38666667 87.04-73.38666667z m0-71.68c-75.09333333 0-143.36 54.61333333-158.72 131.41333334-18.77333333 88.74666667 40.96 172.37333333 128 191.14666666 10.24 1.70666667 22.18666667 3.41333333 32.42666667 3.41333334 18.77333333-1.70666667 34.13333333-1.70666667 49.49333333-1.70666667 242.34666667 0 346.45333333 172.37333333 344.74666667 372.05333333 1.70666667-1.70666667 177.49333333-525.65333333-348.16-687.78666666-6.82666667-1.70666667-30.72-5.12-35.84-6.82666667-1.70666667-1.70666667-8.53333333-1.70666667-11.94666667-1.70666667"></path></svg></div>
          </Tooltip>

          <Tooltip
              content="全屏"
              :is-dark-mode="isDarkMode"
          >
            <div v-if="!isFullScreen" class="upload-btn" @click="isFullScreen = true"><svg class="upload-icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="200" height="200"><path d="M211.97837653 812.54591147h600.8242176V211.60700587H211.97837653v600.9389056z m81.9593216-518.9632h436.90666667v436.994048h-436.90666667v-436.994048z m-177.39175253 27.26843733c22.61538133 0 40.89992533-18.284544 40.89992533-40.90538667V157.0635776h122.8537856c22.62084267 0 40.90538667-18.284544 40.90538667-40.910848s-18.284544-40.910848-40.90538667-40.910848H116.5459456c-22.626304 0-40.90538667 18.284544-40.90538667 40.910848v163.94594987c-0.15291733 22.46792533 18.13162667 40.75246933 40.90538667 40.75246933z m163.7548032 546.24365227H157.4469632V744.21261653c0-22.63176533-18.284544-40.91630933-40.89992533-40.91630933-22.626304 0-40.90538667 18.284544-40.90538667 40.91630933v163.7875712c0 22.626304 18.27908267 40.910848 40.90538667 40.910848h163.91318186c22.626304 0 40.90538667-18.284544 40.90538667-40.910848-0.15947093-22.62084267-18.44401493-40.90538667-41.0648576-40.90538666zM908.38903467 75.087872H744.4758528c-22.61538133 0-40.89992533 18.284544-40.89992533 40.90538667 0 22.626304 18.284544 40.910848 40.89992533 40.910848h122.86470827v122.8865536c0 22.62084267 18.27908267 40.90538667 40.89992533 40.90538666 22.61538133 0 40.89992533-18.284544 40.89992533-40.90538666v-163.79630934c0.1540096-22.62084267-18.12507307-40.90647893-40.75137706-40.90647893z m0 628.2084352c-22.61538133 0-40.89992533 18.284544-40.89992534 40.91630933v122.88109227H744.63423147c-22.626304 0-40.89992533 18.284544-40.89992534 40.90538667 0 22.626304 18.27362133 40.910848 40.89992534 40.910848h163.9186432c22.61538133 0 40.89992533-18.284544 40.89992533-40.910848V744.21261653c-0.15837867-22.63176533-18.43746133-40.91630933-41.06376533-40.91630933z m0 0" fill="#999999"></path></svg></div>
          </Tooltip>

          <Tooltip
              content="取消全屏"
              :is-dark-mode="isDarkMode"
          >
            <div v-if="isFullScreen" class="upload-btn" @click="isFullScreen = false"><svg class="upload-icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="200" height="200"><path d="M730.791936 328.03170987c0-20.05292373-16.41458347-36.4675072-36.4675072-36.4675072H329.6657408c-20.05838507 0-36.46204587 16.41458347-36.46204587 36.4675072v364.658688c0 20.05838507 16.4036608 36.4675072 36.46204587 36.4675072h364.658688c20.05292373 0 36.4675072-16.40912213 36.4675072-36.4675072V328.03170987z m-36.4675072 346.42875733c0 10.94014293-7.29634133 18.23102293-18.23102293 18.23102293H347.90222507c-10.94560427 0-18.23648427-7.29088-18.23648427-18.23102293V346.26819413c0-10.94014293 7.29088-18.23648427 18.23648427-18.23648426h328.1911808c10.9346816 0 18.23102293 7.29634133 18.23102293 18.23648426v328.19227307z m62.64149333-387.2555008c4.3646976 4.35923627 13.08972373 4.35923627 17.45442134 4.35923627h130.86665386c26.16743253 0 43.6109312-17.44349867 43.6109312-43.61639254 0-26.16743253-17.44349867-43.62185387-43.6109312-43.62185386h-26.1783552l56.71703894-56.7115776c17.44349867-17.44896 17.44349867-43.62185387 0-61.07081387-8.7293952-8.72393387-17.45442133-13.08972373-30.53868374-13.08972373s-21.8136576 4.3646976-30.53868373 13.08972373l-56.70611627 56.7115776v-26.1783552c0-26.16743253-17.45442133-43.62185387-43.62185386-43.62185387-26.1783552 0-43.6273152 17.45442133-43.6273152 43.62185387v130.8721152c0 4.3646976 0 13.08972373 4.35923626 17.45442133 4.3646976 8.71847253 13.08863147 17.4424064 21.8136576 21.80164267z m122.14162774 529.19773867h26.1783552c26.16743253 0 43.6109312-17.44896 43.6109312-43.61639254 0-26.1783552-17.44349867-43.6273152-43.6109312-43.6273152H774.4192512c-4.3646976 0-13.08972373 0-17.45442133 4.35923627-8.72393387 4.3646976-17.44896 13.08972373-21.8136576 21.8136576-4.35923627 4.35923627-4.35923627 13.08972373-4.35923627 17.45442133v130.86665387c0 26.16743253 17.44896 43.61639253 43.6273152 43.61639253 26.16743253 0 43.62185387-17.44896 43.62185387-43.61639253v-26.1783552l56.70611626 56.7115776c17.45442133 17.44349867 43.62185387 17.44349867 61.0762752 0 17.44349867-17.45442133 17.44349867-43.62185387 0-61.0762752l-56.71594666-56.70720853zM75.09333333 247.94781013c0 26.17289387 17.45442133 43.61639253 43.62185387 43.61639254h130.86665387c4.35923627 0 13.08972373 0 17.44896-4.35923627 8.72393387-4.35923627 17.44896-13.0842624 21.8136576-21.80273493 4.35923627-4.3646976 4.35923627-13.08972373 4.35923626-17.45442134V117.0767872c0-26.16743253-17.44896-43.62185387-43.62185386-43.62185387-26.17289387 0-43.62185387 17.45442133-43.62185387 43.62185387v26.1783552l-56.71703893-56.7115776c-8.71847253-8.72393387-17.44349867-13.08972373-30.5266688-13.08972373-13.09518507 0-21.8136576 4.3646976-30.53868374 13.08972373-17.44349867 17.44896-17.44349867 43.62185387 0 61.07081387l56.7115776 56.7115776h-26.17289386c-26.1685248 0-43.62294613 17.45442133-43.62294614 43.62185386z m191.93746774 485.57042347c-4.35923627-4.35923627-13.08972373-4.35923627-17.44896-4.35923627H118.7151872c-26.16743253 0-43.62185387 17.44896-43.62185387 43.6273152 0 26.16743253 17.45442133 43.61639253 43.62185387 43.61639254H144.88917333l-56.7115776 56.70611626c-17.44349867 17.45442133-17.44349867 43.62185387 0 61.0762752 17.44349867 17.44349867 43.62185387 17.44349867 61.06535254 0l56.71703893-56.7115776v26.1783552c0 26.16743253 17.44896 43.61639253 43.62185387 43.61639254 26.17289387 0 43.62185387-17.44896 43.62185386-43.61639254V772.78631253c0-4.3646976 0-13.09518507-4.35923626-17.45442133-4.3646976-8.72502613-13.08972373-17.44896-21.8136576-21.8136576z" fill="#999999"></path></svg></div>
          </Tooltip>
        </div>
        <div v-if="!isHtmlMode" class="preview-mask"></div>
        <div v-if="!isHtmlMode" class="preview-content" ref="previewRef" @scroll="handlePreviewScroll" v-html="renderedMarkdown"></div>
        <iframe
            v-else
            class="html-preview-frame"
            :srcdoc="markdownContent"
            ref="htmlPreviewFrame"
        ></iframe>
      </div>
    </main>

    <!-- 页脚 -->
    <footer v-show="!isFullScreen" class="footer">
      <p>© 2025    <a target="_blank" href="https://try-catch.life/">try-catch.life</a></p>
    </footer>

    <!-- 加载提示 -->
    <div class="loading-mask" v-if="isLoading">
      <div class="loading-content">
        <div class="spinner"></div>
        <p class="loading-text">处理中，请稍候...</p>
      </div>
    </div>
  </div>
  <TextToolbar
      :editor-ref="editorRef"
      @format="addContentToEditor"
      :is-dark-mode="isDarkMode"
  />
  <!-- 自定义弹窗 -->
  <CustomToast
      :show-toast="showToast"
      :toast-message="toastMessage"
      :toast-type="toastType"
      @close="showToast = false"
  />
  <!-- 代码块配置弹窗 -->
  <CodeBlockModal
      :visible="showCodeModal"
      :is-dark-mode="isDarkMode"
      :default-language="defaultLang"
      :default-content="defaultCode"
      @close="showCodeModal = false"
      @confirm="handleCodeBlockConfirm"
      @error="(msg: any) => showCustomToast(msg, 'error')"
  />

  <!-- 表格配置弹窗 -->
  <TableModal
      :visible="showTableModal"
      :is-dark-mode="isDarkMode"
      @close="showTableModal = false"
      @confirm="handleTableConfirm"
      @error="(msg: any) => showCustomToast(msg, 'error')"
  />
  <!-- 公式配置弹窗 -->
  <MathModal
      :visible="showMathModal"
      :is-dark-mode="isDarkMode"
      @close="showMathModal = false"
      @confirm="handleMathConfirm"
      @error="(msg: any) => showCustomToast(msg, 'error')"
  />
  <!-- Emoji 搜索弹窗 -->
  <EmojiModal
      :visible="showEmojiModal"
      :is-dark-mode="isDarkMode"
      @close="showEmojiModal = false"
      @select-emoji="handleEmojiSelect"
  />
  <!-- json配置弹窗 -->
  <JsonSchemaModal
      :visible="showJsonModal"
      :is-dark-mode="isDarkMode"
      @close="showJsonModal = false"
      @confirm="handleJsonSchemaConfirm"
      @error="(msg: any) => showCustomToast(msg, 'error')"
  />
</template>

<script setup lang="ts">
import {computed, nextTick, onBeforeUnmount, onMounted, ref, watch} from 'vue';
import {marked} from 'marked';
import DOMPurify from 'dompurify';
import markedKatex from 'marked-katex-extension';
import mermaid from 'mermaid';
import { debounce } from 'lodash-es';
// 1. 引入Prism核心库（替换highlight.js）
// @ts-ignore
import Prism from 'prismjs';
// 3. 引入主题样式（可选其他主题）
import 'prismjs/themes/prism-tomorrow.css';
import {syncScroll} from "../utils/scrollHandler.ts";
// import {initialMarkdownContent} from "../consts/markdownContent.ts";
import { keyboardHandler } from "../utils/keyboardHandler.ts";
import { defineAsyncComponent } from 'vue';
import Tooltip from "../components/Tooltip.vue";
const CodeBlockModal = defineAsyncComponent(() =>
    import('../components/modals/CodeBlockModal.vue')
);
const TableModal = defineAsyncComponent(() =>
    import('../components/modals/TableModal.vue')
);
const MathModal = defineAsyncComponent(() =>
    import('../components/modals/MathModal.vue')
);
const EmojiModal = defineAsyncComponent(() =>
    import('../components/modals/EmojiModal.vue')
);
const JsonSchemaModal = defineAsyncComponent(() =>
    import('../components/modals/JsonSchemaModal.vue')
);
const CustomToast = defineAsyncComponent(() =>
    import('../components/CustomToast.vue')
);
const TextToolbar = defineAsyncComponent(() =>
    import("../components/TextToolbar.vue")
);
// 状态管理
const isDarkMode = ref(true); // 暗黑模式
const isLoading = ref(false);
const showDropdown = ref(false);
const showToast = ref(false);// 弹窗状态
const toastMessage = ref('');
const toastType = ref('success'); // success/error
const onlyEdit = ref(false); // 编辑模式
const onlyPreview = ref(false); // 预览模式

// 获取DOM引用
const editorRef = ref<HTMLTextAreaElement>();
const previewRef = ref<HTMLDivElement>();
// 用于防止滚动事件循环触发的标志
const isSyncing = ref(false);
// 弹窗相关状态
const showTableModal = ref(false); // 控制弹窗显示
const showCodeModal = ref(false);
const showMathModal = ref(false);
const defaultLang = ref('javascript');
const defaultCode = ref();
const showEmojiModal =  ref(false);
const showJsonModal = ref(false);
const isFullScreen = ref(false); // 全屏状态
const isHtmlMode = ref(false);
// 本地存储相关的代码
const STORAGE_KEY = 'markdown-editor-content';
const THEME_KEY = 'markdown-editor-theme';
// 配置 marked 以支持数学公式
marked.use(markedKatex({
  // @ts-ignore
  katexOptions: {
    throwOnError: false,
    displayMode: false,
    strict: 'ignore',
    trust: true
  }
}));
// 配置marked高亮代码
marked.setOptions({
  // @ts-ignore
  highlight: function (code: string, language: string) {
    // 检查 Prism 是否支持该语言
    const validLanguage = Prism.languages[language] ? language : 'plaintext';
    // 使用 Prism 进行代码高亮
    return Prism.highlight(code, Prism.languages[validLanguage], validLanguage);
  },
  breaks: true, // 支持换行
  gfm: true // 支持GFM语法
});
// 初始化Markdown内容
const markdownContent = ref('');

// 渲染后的HTML
const renderedMarkdown = computed(() => {
  // @ts-ignore
  return DOMPurify.sanitize(marked.parse(markdownContent.value));
});

// 处理确认插入代码块
const handleCodeBlockConfirm = (language: string, content: string) => {
  // 生成Markdown代码块语法
  const codeBlock = `\n\`\`\`${language}\n${content || ''}\n\`\`\``;
  // 插入到编辑器
  addContentToEditor(codeBlock);
  // 关闭弹窗
  showCodeModal.value = false;
};

// 处理确认插入表格
const handleTableConfirm = async (rows: number, cols: number) => {
  // 关闭弹窗
  showTableModal.value = false;
  // 生成表格内容（复用原有的generateMarkdownTable方法）
  const {generateMarkdownTable} = await import("../utils/tableGenerator.ts");
  const tableContent = generateMarkdownTable(rows, cols);
  // 插入到编辑器
  addContentToEditor(tableContent);
  // 显示成功提示
  showCustomToast(`已插入 ${rows}行×${cols}列 表格`);
};

const handleMathConfirm = (mathContent: string) => {
  addContentToEditor(mathContent);
  showMathModal.value = false;
  showCustomToast('已插入公式');
};

const handleJsonSchemaConfirm = (schemaContent: string) => {
  addContentToEditor(schemaContent);
  showJsonModal.value = false;
  showCustomToast('已插入JSON Schema');
};


const openFileSelect = () => {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'image/*,.html,.md,.pdf,.txt,.doc,.docx';
  input.multiple = false; // 设置为false表示只允许选择单个文件
  input.onchange = (e) => handleFileSelect(e);

  input.click();
};

// 处理文件选择（不再需要传入文件类型参数）
const handleFileSelect = async (e: Event) => {
  const target = e.target as HTMLInputElement;
  const file = target.files?.[0];
  if (!file) return;

  try {
    isLoading.value = true;

    // 根据文件类型自动判断处理方式
    const { FileUploadHandler } = await import("../utils/uploadHandler.ts");
    let content: string;

    // 判断文件是否为图片类型
    if (file.type.startsWith('image/')) {
      // 处理图片
      content = await FileUploadHandler.handleImage(file);
    } else {
      // 处理其他类型文件
      content = await FileUploadHandler.handleFile(file);
    }

    showCustomToast('上传成功！', 'success');
    addContentToEditor(`\n${content}`);
  } catch (error) {
    console.error('上传失败:', error);
    showCustomToast('上传失败，请重试', 'error');
  } finally {
    isLoading.value = false;
    target.value = ''; // 允许重复选择同一文件
  }
};

const handleEmojiSelect = (emojiUnicode: string) => {
  // 调用现有方法将 Emoji 插入到编辑器光标位置
  addContentToEditor(emojiUnicode);
  // 关闭弹窗
  showEmojiModal.value = false;
};

// 点击空白处关闭下拉菜单
const handleClickOutside = (e: any) => {
  const dropdown = document.querySelector('.dropdown-menu');
  if (dropdown && !dropdown.contains(e.target)) {
    showDropdown.value = false;
  }
};

const downloadMarkdown = async () => {
  showDropdown.value = false;
  try {
    // 动态导入downloadHandler.ts
    const { markdownHandler } = await import("../utils/downloadHandler.ts");
    markdownHandler(markdownContent.value);
    showCustomToast('Markdown文件下载成功');
  } catch (error: any) {
    showCustomToast('下载失败：' + error.message, 'error');
  }
};

const downloadHtml = async () => {
  showDropdown.value = false;
  try {
    const { htmlHandler } = await import("../utils/downloadHandler.ts");
    htmlHandler(markdownContent.value);
    showCustomToast('html代码下载成功');
  } catch (error: any) {
    showCustomToast('下载失败：' + error.message, 'error');
  }
};

// 下载PDF文件
const downloadPdf = async () => {
  showDropdown.value = false;
  isLoading.value = true;
  let tempElement: any;
  try {
    // 动态导入
    const [html2pdfModule, mermaidModule] = await Promise.all([
        // @ts-ignore
      import('html2pdf.js'),
      import('mermaid')
    ]);

    const html2pdf = html2pdfModule.default;
    const mermaid = mermaidModule.default;
    const { pdfHandler } = await import("../utils/downloadHandler.ts");

    mermaid.initialize({
      theme: 'default',
      securityLevel: 'loose',
      fontFamily: 'inherit',
    });

    tempElement = await pdfHandler(renderedMarkdown, mermaid);
    // document.body.appendChild(tempElement);
    const {pdfOptions} = await import("../consts/pdfConfig.ts");
    await html2pdf().from(tempElement).set(pdfOptions).save();
    showCustomToast('PDF文件下载成功');
  } catch (error: any) {
    showCustomToast('PDF生成失败：' + error.message, 'error');
  } finally {
    // document.body.removeChild(tempElement);
    isLoading.value = false;
  }
};
// 编辑器滚动时同步到预览区（绑定到编辑器的scroll事件）
const handleEditorScroll = () => {
  syncScroll(editorRef, previewRef, isSyncing);
};

// 预览区滚动时同步到编辑器（绑定到预览区的scroll事件）
const handlePreviewScroll = () => {
  syncScroll(previewRef, editorRef, isSyncing);
};


// 解决Tab按键冲突
const handleKeyDown = async (e: KeyboardEvent) => {
  // 动态导入keyboardHandler.ts
  await keyboardHandler(e, editorRef, markdownContent);
};
// 工具类：显示自定义弹窗
const showCustomToast = (message: any, type = 'success') => {
  toastMessage.value = message;
  toastType.value = type;
  showToast.value = true;
  // 3秒后自动关闭
  setTimeout(() => {
    showToast.value = false;
  }, 3000);
};

// 工具类：插入内容到光标处
const addContentToEditor = (content: string) => {
  if (!editorRef.value) return;
  // 插入表格到编辑器（光标位置）
  const editor = editorRef.value;
  const startPos = editor.selectionStart;
  const endPos = editor.selectionEnd;

  markdownContent.value =
      markdownContent.value.substring(0, startPos) +
      content+
      markdownContent.value.substring(endPos);
}

// 监听代码块的高亮
watch(markdownContent, () => {
  nextTick(() => {
    // 只高亮预览区域内的代码块
    const previewContainer = document.querySelector('.preview-content');
    if (previewContainer) {
      previewContainer.querySelectorAll('pre code').forEach((block) => {
        // 使用 Prism 进行代码高亮
        Prism.highlightElement(block as HTMLElement);
      });
      renderMermaidCharts();
    }
  });
});

// 监听代码块的高亮
watch(isHtmlMode, (curMode) => {
  nextTick(() => {
    if(!curMode){
      // 只高亮预览区域内的代码块
      const previewContainer = document.querySelector('.preview-content');
      if (previewContainer) {
        previewContainer.querySelectorAll('pre code').forEach((block) => {
          // 使用 Prism 进行代码高亮
          Prism.highlightElement(block as HTMLElement);
        });
        renderMermaidCharts();
      }
    }
  });
});


// 保存内容到本地存储（防抖）
const saveToLocalStorage = debounce((content: string) => {
  try {
    localStorage.setItem(STORAGE_KEY, content);
    console.log('内容已自动保存');
  } catch (error) {
    console.warn('本地存储失败:', error);
    // 处理存储空间不足的情况
    if (error instanceof DOMException && error.name === 'QuotaExceededError') {
      showCustomToast('存储空间不足，部分内容可能无法保存', 'warning');
    }
  }
}, 1000); // 防抖

// 从本地存储加载内容
const loadFromLocalStorage = (): string => {
  try {
    return localStorage.getItem(STORAGE_KEY) || '';
  } catch (error) {
    console.warn('读取本地存储失败:', error);
    return '';
  }
};

// 渲染 Mermaid 图表的函数
const renderMermaidCharts = () => {
  if (!previewRef.value) return;

  const mermaidElements = previewRef.value.querySelectorAll('code.language-mermaid');

  mermaidElements.forEach((element) => {
    const content = element.textContent?.trim();
    if (!content) return;

    // 检查是否已经渲染过
    if (element.parentElement?.classList.contains('mermaid-processed')) {
      return;
    }

    try {
      // 隐藏原始的代码块
      // @ts-ignore
      element.style.display = 'none';

      // 标记父元素已处理
      if (element.parentElement) {
        element.parentElement.classList.add('mermaid-processed');
      }

      // 创建容器用于渲染
      const container = document.createElement('div');
      container.className = 'mermaid-container';

      // 插入到代码块前面
      element.parentNode?.insertBefore(container, element);

      // 使用 Mermaid 渲染
      mermaid.render(`mermaid-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`, content)
          .then(({ svg }) => {
            container.innerHTML = svg;
          })
          .catch((error) => {
            console.error('Mermaid 渲染错误:', error);
            // 显示错误信息，同时恢复原始代码块显示
            // @ts-ignore
            element.style.display = 'block';
            container.innerHTML = `<div class="mermaid-error">
            Mermaid 图表渲染错误: ${error.message}
          </div>`;
          });
    } catch (error) {
      console.error('Mermaid 处理错误:', error);
      // 出错时恢复显示原始代码块
      // @ts-ignore
      element.style.display = 'block';
    }
  });
};

const toggleTheme = () => {
  isDarkMode.value = !isDarkMode.value;
  localStorage.setItem(THEME_KEY, isDarkMode.value ? 'dark' : 'light');
}

// 监听内容变化并自动保存
watch(markdownContent, (newContent) => {
    saveToLocalStorage(newContent);
});

onMounted(() => {
  // 监听点击事件关闭下拉菜单
  document.addEventListener('click', handleClickOutside);
  const savedContent = loadFromLocalStorage();
  const theme = localStorage.getItem(THEME_KEY);
  console.log('theme', theme);
  if (theme) {
    isDarkMode.value = theme === 'dark';
  }
  if (savedContent) {
    markdownContent.value = savedContent;
    console.log('已恢复上次编辑的内容');
  }
  // 初始化 Mermaid 配置
  mermaid.initialize({
    startOnLoad: true,
    theme: 'default',
    securityLevel: 'loose',
    fontFamily: 'inherit',
  });

  // 添加 beforeunload 提示
  window.addEventListener('beforeunload', (e) => {
    if (markdownContent.value.trim()) {
      e.preventDefault();
    }
  });
});

// 在组件卸载时移除事件监听
onBeforeUnmount(() => {
  document.removeEventListener('click', handleClickOutside);
  saveToLocalStorage.flush();

});

</script>

<style scoped>
@import '../styles/editArea.css';
@import '../styles/previewArea.css';
@import '../styles/common.css';
@import '../styles/header.css';
@import '../styles/loading.css';
</style>
